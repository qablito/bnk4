name: repo-integrity

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  integrity:
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Validate tracked app sources
        run: python3 CHECKS/validate_repo_integrity.py

      - name: Optional analyzer-web type-check (if dependencies already present)
        if: ${{ hashFiles('apps/analyzer-web/package.json', 'apps/analyzer-web/package-lock.json') != '' }}
        run: |
          if [ -d apps/analyzer-web/node_modules ]; then
            npm --prefix apps/analyzer-web run type-check
          else
            echo "Skipping analyzer-web type-check (node_modules not installed in this lightweight job)."
          fi

      - name: Optional analyzer-api tests (if pytest available)
        run: |
          if python3 -c "import pytest" >/dev/null 2>&1; then
            pytest -q -rs apps/analyzer-api
          else
            echo "Skipping analyzer-api tests (pytest not installed in this lightweight job)."
          fi
